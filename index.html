<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>OpenStreetMapに位置を表示</title>
<style>
    #mapDiv {width: 100%; height: 400px;}
</style>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
</head>

<body>
<div id="txt">ここにデータを表示</div>
<p><a href="./gacha.html">>>ガチャを引く</a></p>
<div id="mapDiv"></div>

<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script>
// 累計移動距離とポイントを初期化
let totalDistance = 0;
let points = 100;  // 初期ポイントを100に設定
let previousPosition = null;
let previousTimestamp = null;

var mapDiv = document.getElementById("mapDiv");
var map;
var marker;

navigator.geolocation.watchPosition( (position) => {
    var lat  = position.coords.latitude;
    var lng  = position.coords.longitude;
    var accu = position.coords.accuracy;
    var currentTimestamp = position.timestamp;

    displayData(lat, lng, accu);
    showMyPos(lat, lng);
    calculateDistance(lat, lng, currentTimestamp);
}, (error) => {
    console.error(error);
}, {
    enableHighAccuracy: true
});

function displayData(lat, lng, accu) {
    var txt = document.getElementById("txt");
    txt.innerHTML = "緯度, 経度: " + lat + ", " + lng + "<br>"
                  + "精度: " + accu + "<br>"
                  + "累計移動距離: " + totalDistance.toFixed(2) + " km<br>"
                  + "ポイント: " + points.toFixed(2) + "pt";
}

function showMyPos(lat, lng) {
    var myPos = [lat, lng];
    map.setView(myPos, 16);
    if (marker) {
        marker.setLatLng(myPos);
    } else {
        marker = L.marker(myPos).addTo(map);
    }
}

// 移動距離を計算し速度を検知する関数
function calculateDistance(lat, lng, currentTimestamp) {
    if (previousPosition && previousTimestamp) {
        const R = 6371; // 地球の半径 (km)
        const φ1 = previousPosition.lat * Math.PI / 180;
        const φ2 = lat * Math.PI / 180;
        const Δφ = (lat - previousPosition.lat) * Math.PI / 180;
        const Δλ = (lng - previousPosition.lng) * Math.PI / 180;

        const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                  Math.cos(φ1) * Math.cos(φ2) *
                  Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

        const distance = R * c; // 距離 (km)
        const timeElapsed = (currentTimestamp - previousTimestamp) / 1000; // 経過時間 (秒)
        const speed = (distance * 1000) / timeElapsed; // 速度 (m/s)

        // 速度が8.33m/s (時速30km) を超えたらエラーを表示
        if (speed > 10) {
            alert("時速36kmを超える速度です。計測を停止します。");
            return; // それ以上の計算をせずに終了
        }

        totalDistance += distance; // 累計移動距離に加算
        points += distance / 0.012; // ポイントに加算（10mで1.2ポイント）
    }

    previousPosition = { lat, lng };
    previousTimestamp = currentTimestamp;
}

// 地図の初期化
function initMap() {
    navigator.geolocation.getCurrentPosition( (position) => {
        var lat = position.coords.latitude;
        var lng = position.coords.longitude;
        var initPos = [lat, lng];
        map = L.map(mapDiv).setView(initPos, 16);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        marker = L.marker(initPos).addTo(map);
    }, (error) => {
        console.error(error);
    }, {
        enableHighAccuracy: true
    });
}

initMap();
</script>
</body>
</html>
